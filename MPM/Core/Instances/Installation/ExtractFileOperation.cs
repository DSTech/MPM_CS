using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using ICSharpCode.SharpZipLib;
using ICSharpCode.SharpZipLib.Core;
using ICSharpCode.SharpZipLib.Zip;
using MPM.Archival;
using MPM.Core.Instances.Cache;
using Platform.VirtualFileSystem;

namespace MPM.Core.Instances.Installation {
    /// <summary>
    ///     An operation to extract a file from a cached archive to a specified target.
    /// </summary>
    public class ExtractFileOperation : IFileOperation {
        public ExtractFileOperation() {
        }

        public ExtractFileOperation(string packageName, SemVer.Version packageVersion, string archiveCacheEntry, string sourcePath) {
            this.PackageName = PackageName;
            this.PackageVersion = packageVersion;
            this.ArchiveCacheEntry = archiveCacheEntry;
            this.SourcePath = sourcePath;
        }

        public bool UsesPreviousContents => false;

        public string ArchiveCacheEntry { get; set; }

        public string SourcePath { get; set; }

        public string PackageName { get; set; }

        public SemVer.Version PackageVersion { get; set; }

        public void Perform(IFileSystem fileSystem, String path, ICacheReader cache) {
            var targetFile = fileSystem.ResolveFile(path);
            if (targetFile.Exists) {
                targetFile.Delete();
            }
            var targetDir = targetFile.ResolveDirectory(".");
            if (!targetDir.Exists) {
                targetDir.Create(true);
            }
            var cacheEntry = cache.Fetch(ArchiveCacheEntry);
            if (cacheEntry == null) {
                throw new KeyNotFoundException($"Cache did not contain an entry for {ArchiveCacheEntry}");
            }
            var entryStream = cacheEntry.FetchStream();
            if (entryStream.CanSeek) {
                using (var fileWriter = targetFile.GetContent().GetOutputStream(System.IO.FileMode.Create)) {
                    using (var seeker = new SeekingZipFetcher(entryStream)) {
                        using (var zipStream = seeker.FetchFileStream(SourcePath)) {
                            zipStream.CopyTo(fileWriter);
                        }
                    }
                }
            } else {
                using (var zip = new StreamingZipFetcher(entryStream)) {
                    using (var fileWriter = targetFile.GetContent().GetOutputStream(System.IO.FileMode.Create)) {
                        var sourceFile = zip.FetchFile(SourcePath);
                        fileWriter.Write(sourceFile, 0, sourceFile.Length);
                    }
                }
            }
        }

        public override string ToString() => $"<Extract {ArchiveCacheEntry}>";
    }
}
